"use strict";"require form";"require fs";"require network";"require poll";"require rpc";"require uci";"require view";"require tools.widgets as widgets";const status_url="/cgi-bin/luci/admin/services/coovachilli/status";async function getStatus(){try{const response=await fetch(status_url);if(!response.ok)throw new Error("Fetch failed");const data=await response.json();return{isRunning:data.running||!1,pid:data.pid||null,backendState:data.backendState,authURL:data.authURL,displayName:data.displayName,onlineExitNodes:data.onlineExitNodes||[],subnetRoutes:data.subnetRoutes||[],}}catch(e){return{isRunning:!1,backendState:undefined,authURL:undefined,displayName:undefined,onlineExitNodes:[],subnetRoutes:[]}}}
function renderStatus(statusData){const spanTemplate='<em><span style="color:%s"><strong>%s %s</strong></span></em>';if(statusData.isRunning){return String.format('<em><span style="color:green"><strong>%s %s (PID: %s)</strong></span></em>',_("Coova Chilli"),_("RUNNING"),statusData.pid||"?")}else{return String.format(spanTemplate,"red",_("Coova Chilli"),_("NOT RUNNING"))}}
return view.extend({load(){return Promise.all([uci.load("chilli"),getStatus()])},render(data){const statusData=data[1];const m=new form.Map("chilli",_("").toString(),_("").toString());const sStatus=m.section(form.TypedSection);sStatus.anonymous=!0;sStatus.render=function(){let alreadyHandled=!1;poll.add(async function(){const res=await getStatus();const el=document.getElementById("service_status");if(el)el.innerHTML=renderStatus(res);uci.load("chilli").then(()=>{const enabled=uci.get("chilli","settings","disabled");if(enabled==="1"&&res.isRunning&&!alreadyHandled){alreadyHandled=!0;fetch("/cgi-bin/luci/admin/services/coovachilli/stop",{method:"POST"})}else if(enabled==="0"&&!res.isRunning&&!alreadyHandled){alreadyHandled=!0;fetch("/cgi-bin/luci/admin/services/coovachilli/start",{method:"POST"})}
if((enabled==="1"&&!res.isRunning)||(enabled==="0"&&res.isRunning)){alreadyHandled=!1}})});return E("div",{class:"cbi-section",id:"status_bar"},[E("p",{id:"service_status"},[E("img",{src:"/luci-static/resources/icons/loading.gif",style:"width:16px; height:16px; vertical-align:middle; margin-right:5px;"})," ",_("Collecting data ...")])])};const s=m.section(form.NamedSection,"settings","config");s.tab("basic",_("Basic Settings"));let o=s.taboption("basic",form.Flag,"disabled",_("Enable"));o.enabled="0";o.disabled="1";o.default=o.disabled;o.rmempty=!1;o=s.taboption("basic",widgets.DeviceSelect,"dhcpif",_("Interface"),_("Network interface for loginpage."));o.noaliases=!1;o.default="br-radius";o.rmempty=!1;o=s.taboption("basic",form.Value,"net",_("IP Address"));o.rmempty=!1;o=s.taboption("basic",form.Value,"dns1",_("Dns1"));o.rmempty=!1;o=s.taboption("basic",form.Value,"dns2",_("Dns2"));o.rmempty=!1;const tombolSection=m.section(form.TypedSection);tombolSection.anonymous=!0;tombolSection.render=function(){const container=E("div",{class:"cbi-section"},E("div",{style:"display:flex; gap:10px; flex-wrap:wrap;"},[E("button",{class:"btn cbi-button cbi-button-apply",id:"btnStart"},_("Start")),E("button",{class:"btn cbi-button cbi-button-reset",id:"btnStop"},_("Stop")),E("input",{type:"button",class:"btn cbi-button cbi-button-remove",id:"btnRestart",value:_("Restart")})]));setTimeout(()=>{const serviceStatus=document.getElementById("service_status");function setLoadingStatus(){if(serviceStatus){serviceStatus.innerHTML=`
                            <span>
                                <img src="/luci-static/resources/icons/loading.gif" 
                                     style="width:16px; height:16px; vertical-align:middle; margin-right:5px;">
                                Collecting data ...
                            </span>
                        `}}
async function handleAction(url){setLoadingStatus();await fetch(url,{method:"POST"});const res=await getStatus();serviceStatus.innerHTML=renderStatus(res)}
document.getElementById("btnStart")?.addEventListener("click",()=>{handleAction("/cgi-bin/luci/admin/services/coovachilli/start")});document.getElementById("btnStop")?.addEventListener("click",()=>{handleAction("/cgi-bin/luci/admin/services/coovachilli/stop")});document.getElementById("btnRestart")?.addEventListener("click",()=>{handleAction("/cgi-bin/luci/admin/services/coovachilli/restart")})},0);return container};s.tab("advance",_("Advance Settings"));o=s.taboption("advance",form.Value,"uamlisten",_("Uamlisten"));o.default="";o.rmempty=!0;o=s.taboption("advance",form.Value,"uamserver",_("Uamserver"));o.default="";o.rmempty=!0;o=s.taboption("advance",form.DynamicList,"uamallowed",_("Uamallowed"));o.cfgvalue=function(section_id){var val=uci.get("chilli",section_id,"uamallowed");return val?val.split(/\s*,\s*/).filter(Boolean):[]};o.write=function(section_id,formvalue){uci.set("chilli",section_id,"uamallowed",Array.isArray(formvalue)?formvalue.join(","):"")};o=s.taboption("advance",form.DynamicList,"uamdomain",_("Uamdomain"));o.cfgvalue=function(section_id){var val=uci.get("chilli",section_id,"uamdomain");return val?val.split(/\s*,\s*/).filter(Boolean):[]};o.write=function(section_id,formvalue){uci.set("chilli",section_id,"uamdomain",Array.isArray(formvalue)?formvalue.join(","):"")};s.tab("macbind",_("Mac Binding"));o=s.taboption("macbind",form.Flag,"macauth",_("Mac Auth"));o.default=o.disabled;o.rmempty=!1;o=s.taboption("macbind",form.DynamicList,"macallowed",_("Mac Allowed"));o.cfgvalue=function(section_id){var val=uci.get("chilli",section_id,"macallowed");return val?val.split(/\s*,\s*/).filter(Boolean):[]};o.write=function(section_id,formvalue){uci.set("chilli",section_id,"macallowed",Array.isArray(formvalue)?formvalue.join(","):"")};return m.render()}})
